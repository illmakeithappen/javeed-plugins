<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wochenplan-Freigabe</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  @media print { .no-print { display: none !important; } }
  .alt-row { display: none; }
  .alt-row.open { display: table-row; }
  .row-accepted { background-color: #f0fdf4 !important; }
  .row-declined { background-color: #fef2f2 !important; }
  body { font-family: system-ui, -apple-system, sans-serif; }
</style>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen">

<script id="plan-data" type="application/json">
{
  "plan_id": "plan-e1ae80a63763",
  "snapshot_id": "hinweg-2026-02-23-2026-03-01-70a6664d",
  "betrieb": "Hin&Weg",
  "profile": "hinweg_march_2026",
  "range": { "from": "2026-02-23", "to": "2026-03-01" },
  "kpis": {
    "assigned_slots": 7,
    "unassigned_slots": 0,
    "fill_rate": 100,
    "assignment_kinds": { "applicant": 2, "recommendation_without_applicant": 5 }
  },
  "assignments": [
    {
      "assignment_id": "019b9330-a299-79f9-ba2e-cb4a892fe3ad-open-1::019a4f8d-75be-718a-938f-4673d46d313b",
      "date": "2026-02-23", "start": "10:00", "end": "13:00",
      "shift_type": "frueh", "working_area": "Kiosk",
      "employee": "Raphael Yasin Morsi", "is_applicant": true,
      "reasons": ["applied_for_shift", "remaining_target_hours", "fair_distribution"],
      "score_detail": { "rest": 24.35, "fairness": 18, "role": 10, "skill": 12, "fixed": 0, "preference": 0, "applicant": 80, "salary": 0 },
      "alternatives": [
        { "employee_name": "Annika Geyer", "score": 92, "is_applicant": false, "reasons": ["remaining_target_hours", "fair_distribution", "skill_working_area_match"], "score_detail": { "rest": 40, "fairness": 30, "role": 10, "skill": 12, "fixed": 0, "preference": 0, "applicant": 0, "salary": 0 } },
        { "employee_name": "Carlo Sohn", "score": 92, "is_applicant": false, "reasons": ["remaining_target_hours", "fair_distribution", "skill_working_area_match"], "score_detail": { "rest": 40, "fairness": 30, "role": 10, "skill": 12, "fixed": 0, "preference": 0, "applicant": 0, "salary": 0 } },
        { "employee_name": "Ece Genca", "score": 92, "is_applicant": false, "reasons": ["remaining_target_hours", "fair_distribution", "skill_working_area_match"], "score_detail": { "rest": 40, "fairness": 30, "role": 10, "skill": 12, "fixed": 0, "preference": 0, "applicant": 0, "salary": 0 } }
      ]
    },
    {
      "assignment_id": "019b9330-a2d7-7888-be19-00a0245c10b6-open-1::019b3268-fbe8-702e-88fb-5a51481a1480",
      "date": "2026-02-24", "start": "06:45", "end": "14:45",
      "shift_type": "frueh", "working_area": "Kiosk",
      "employee": "Annika Geyer", "is_applicant": false,
      "reasons": ["remaining_target_hours", "fair_distribution", "skill_working_area_match"],
      "score_detail": { "rest": 40, "fairness": 30, "role": 10, "skill": 12, "fixed": 0, "preference": 0, "applicant": 0, "salary": 0 },
      "alternatives": [
        { "employee_name": "Carlo Sohn", "score": 92, "is_applicant": false, "reasons": ["remaining_target_hours", "fair_distribution", "skill_working_area_match"], "score_detail": { "rest": 40, "fairness": 30, "role": 10, "skill": 12, "fixed": 0, "preference": 0, "applicant": 0, "salary": 0 } },
        { "employee_name": "Jan Kranz", "score": 92, "is_applicant": false, "reasons": ["remaining_target_hours", "fair_distribution", "skill_working_area_match"], "score_detail": { "rest": 40, "fairness": 30, "role": 10, "skill": 12, "fixed": 0, "preference": 0, "applicant": 0, "salary": 0 } },
        { "employee_name": "Lukas Sorgalla", "score": 92, "is_applicant": false, "reasons": ["remaining_target_hours", "fair_distribution", "skill_working_area_match"], "score_detail": { "rest": 40, "fairness": 30, "role": 10, "skill": 12, "fixed": 0, "preference": 0, "applicant": 0, "salary": 0 } }
      ]
    },
    {
      "assignment_id": "019b9330-a48a-71b4-923b-e3d6a29b067f-open-1::01987e91-e110-7bba-ad00-33135033ca4e",
      "date": "2026-02-27", "start": "10:00", "end": "14:00",
      "shift_type": "frueh", "working_area": "Produktion / Backen",
      "employee": "Marco Hiller", "is_applicant": false,
      "reasons": ["remaining_target_hours", "fair_distribution", "skill_working_area_match"],
      "score_detail": { "rest": 40, "fairness": 30, "role": 10, "skill": 12, "fixed": 0, "preference": 0, "applicant": 0, "salary": 0 },
      "alternatives": [
        { "employee_name": "Marli Spitz", "score": 92, "is_applicant": false, "reasons": ["remaining_target_hours", "fair_distribution", "skill_working_area_match"], "score_detail": { "rest": 40, "fairness": 30, "role": 10, "skill": 12, "fixed": 0, "preference": 0, "applicant": 0, "salary": 0 } },
        { "employee_name": "Nikolai Koenighaus", "score": 92, "is_applicant": false, "reasons": ["remaining_target_hours", "fair_distribution", "skill_working_area_match"], "score_detail": { "rest": 40, "fairness": 30, "role": 10, "skill": 12, "fixed": 0, "preference": 0, "applicant": 0, "salary": 0 } },
        { "employee_name": "Pia Sohn", "score": 92, "is_applicant": false, "reasons": ["remaining_target_hours", "fair_distribution", "skill_working_area_match"], "score_detail": { "rest": 40, "fairness": 30, "role": 10, "skill": 12, "fixed": 0, "preference": 0, "applicant": 0, "salary": 0 } }
      ]
    },
    {
      "assignment_id": "019b9330-a493-728a-b5c2-92a283ab2525-open-1::1efa8d11-e12a-66cc-ad5d-39e79b4b5fb6",
      "date": "2026-02-27", "start": "15:00", "end": "22:30",
      "shift_type": "spaet", "working_area": "Kiosk",
      "employee": "Carlo Sohn", "is_applicant": false,
      "reasons": ["remaining_target_hours", "fair_distribution", "skill_working_area_match"],
      "score_detail": { "rest": 40, "fairness": 30, "role": 10, "skill": 12, "fixed": 0, "preference": 0, "applicant": 0, "salary": 0 },
      "alternatives": [
        { "employee_name": "Jan Kranz", "score": 92, "is_applicant": false, "reasons": ["remaining_target_hours", "fair_distribution", "skill_working_area_match"], "score_detail": { "rest": 40, "fairness": 30, "role": 10, "skill": 12, "fixed": 0, "preference": 0, "applicant": 0, "salary": 0 } },
        { "employee_name": "Lukas Sorgalla", "score": 92, "is_applicant": false, "reasons": ["remaining_target_hours", "fair_distribution", "skill_working_area_match"], "score_detail": { "rest": 40, "fairness": 30, "role": 10, "skill": 12, "fixed": 0, "preference": 0, "applicant": 0, "salary": 0 } },
        { "employee_name": "Luma Klein Spindola", "score": 92, "is_applicant": false, "reasons": ["remaining_target_hours", "fair_distribution", "skill_working_area_match"], "score_detail": { "rest": 40, "fairness": 30, "role": 10, "skill": 12, "fixed": 0, "preference": 0, "applicant": 0, "salary": 0 } }
      ]
    },
    {
      "assignment_id": "019b9330-a49d-7085-a782-55e676b154a0-open-1::0195e81f-017e-74fe-bd42-07e954d34d2c",
      "date": "2026-02-28", "start": "16:00", "end": "22:30",
      "shift_type": "spaet", "working_area": "Kiosk",
      "employee": "Jan Kranz", "is_applicant": false,
      "reasons": ["remaining_target_hours", "fair_distribution", "skill_working_area_match"],
      "score_detail": { "rest": 40, "fairness": 30, "role": 10, "skill": 12, "fixed": 0, "preference": 0, "applicant": 0, "salary": 0 },
      "alternatives": [
        { "employee_name": "Lukas Sorgalla", "score": 92, "is_applicant": false, "reasons": ["remaining_target_hours", "fair_distribution", "skill_working_area_match"], "score_detail": { "rest": 40, "fairness": 30, "role": 10, "skill": 12, "fixed": 0, "preference": 0, "applicant": 0, "salary": 0 } },
        { "employee_name": "Luma Klein Spindola", "score": 92, "is_applicant": false, "reasons": ["remaining_target_hours", "fair_distribution", "skill_working_area_match"], "score_detail": { "rest": 40, "fairness": 30, "role": 10, "skill": 12, "fixed": 0, "preference": 0, "applicant": 0, "salary": 0 } },
        { "employee_name": "Marlene Charlotte Henning", "score": 92, "is_applicant": false, "reasons": ["remaining_target_hours", "fair_distribution", "skill_working_area_match"], "score_detail": { "rest": 40, "fairness": 30, "role": 10, "skill": 12, "fixed": 0, "preference": 0, "applicant": 0, "salary": 0 } }
      ]
    },
    {
      "assignment_id": "019c340f-b63a-701b-ab96-995e2ea7789a-open-1::01981f74-5af0-7388-974f-8526b11dfb0f",
      "date": "2026-03-01", "start": "10:00", "end": "16:00",
      "shift_type": "frueh", "working_area": "Kiosk",
      "employee": "Felix Ebertz", "is_applicant": true,
      "reasons": ["applied_for_shift", "fair_distribution", "remaining_target_hours"],
      "score_detail": { "rest": 20, "fairness": 30, "role": 10, "skill": 12, "fixed": 0, "preference": 0, "applicant": 80, "salary": 0 },
      "alternatives": [
        { "employee_name": "Annika Geyer", "score": 92, "is_applicant": false, "reasons": ["remaining_target_hours", "fair_distribution", "skill_working_area_match"], "score_detail": { "rest": 40, "fairness": 30, "role": 10, "skill": 12, "fixed": 0, "preference": 0, "applicant": 0, "salary": 0 } },
        { "employee_name": "Carlo Sohn", "score": 92, "is_applicant": false, "reasons": ["remaining_target_hours", "fair_distribution", "skill_working_area_match"], "score_detail": { "rest": 40, "fairness": 30, "role": 10, "skill": 12, "fixed": 0, "preference": 0, "applicant": 0, "salary": 0 } },
        { "employee_name": "Jan Kranz", "score": 92, "is_applicant": false, "reasons": ["remaining_target_hours", "fair_distribution", "skill_working_area_match"], "score_detail": { "rest": 40, "fairness": 30, "role": 10, "skill": 12, "fixed": 0, "preference": 0, "applicant": 0, "salary": 0 } }
      ]
    },
    {
      "assignment_id": "019c340f-f26e-79ba-8367-31e51e82060a-open-1::1efa8cde-052a-6970-98af-a93ec2eaee0a",
      "date": "2026-03-01", "start": "16:00", "end": "22:30",
      "shift_type": "spaet", "working_area": "Kiosk",
      "employee": "Lukas Sorgalla", "is_applicant": false,
      "reasons": ["remaining_target_hours", "fair_distribution", "skill_working_area_match"],
      "score_detail": { "rest": 40, "fairness": 30, "role": 10, "skill": 12, "fixed": 0, "preference": 0, "applicant": 0, "salary": 0 },
      "alternatives": [
        { "employee_name": "Luma Klein Spindola", "score": 92, "is_applicant": false, "reasons": ["remaining_target_hours", "fair_distribution", "skill_working_area_match"], "score_detail": { "rest": 40, "fairness": 30, "role": 10, "skill": 12, "fixed": 0, "preference": 0, "applicant": 0, "salary": 0 } },
        { "employee_name": "Marlene Charlotte Henning", "score": 92, "is_applicant": false, "reasons": ["remaining_target_hours", "fair_distribution", "skill_working_area_match"], "score_detail": { "rest": 40, "fairness": 30, "role": 10, "skill": 12, "fixed": 0, "preference": 0, "applicant": 0, "salary": 0 } },
        { "employee_name": "Nikolai Koenighaus", "score": 92, "is_applicant": false, "reasons": ["remaining_target_hours", "fair_distribution", "skill_working_area_match"], "score_detail": { "rest": 40, "fairness": 30, "role": 10, "skill": 12, "fixed": 0, "preference": 0, "applicant": 0, "salary": 0 } }
      ]
    }
  ]
}
</script>

<div id="app" class="max-w-7xl mx-auto px-4 py-6">

  <!-- Header -->
  <div class="bg-white border border-gray-200 rounded-lg p-5 mb-4">
    <div class="flex flex-wrap items-baseline justify-between gap-2 mb-3">
      <h1 class="text-xl font-bold">Wochenplan-Freigabe</h1>
      <span class="text-sm text-gray-500" id="meta-line"></span>
    </div>

    <!-- KPI row -->
    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3 mb-4" id="kpi-bar"></div>

    <!-- Decision summary + bulk actions -->
    <div class="flex flex-wrap items-center gap-3 pt-3 border-t border-gray-100">
      <span id="count-pending" class="inline-flex items-center px-2.5 py-1 rounded text-sm font-medium bg-gray-100 text-gray-700"></span>
      <span id="count-accepted" class="inline-flex items-center px-2.5 py-1 rounded text-sm font-medium bg-green-100 text-green-800"></span>
      <span id="count-declined" class="inline-flex items-center px-2.5 py-1 rounded text-sm font-medium bg-red-100 text-red-800"></span>
      <div class="flex-1"></div>
      <button onclick="acceptAll()" class="no-print px-3 py-1.5 text-sm font-medium rounded bg-green-600 text-white hover:bg-green-700">Alle annehmen</button>
      <button onclick="resetAll()" class="no-print px-3 py-1.5 text-sm font-medium rounded bg-gray-200 text-gray-700 hover:bg-gray-300">Zuruecksetzen</button>
    </div>
  </div>

  <!-- Filters -->
  <div class="no-print bg-white border border-gray-200 rounded-lg p-4 mb-4 flex flex-wrap items-center gap-3">
    <input type="text" id="search" placeholder="Suche: Name, Bereich, Datum..."
           class="flex-1 min-w-[200px] px-3 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
           oninput="render()">
    <div class="flex gap-1">
      <button onclick="setFilter('type','all')" data-filter="type-all" class="filter-btn px-3 py-1.5 text-sm rounded border">Alle</button>
      <button onclick="setFilter('type','frueh')" data-filter="type-frueh" class="filter-btn px-3 py-1.5 text-sm rounded border">Frueh</button>
      <button onclick="setFilter('type','spaet')" data-filter="type-spaet" class="filter-btn px-3 py-1.5 text-sm rounded border">Spaet</button>
    </div>
    <div class="flex gap-1">
      <button onclick="setFilter('status','all')" data-filter="status-all" class="filter-btn px-3 py-1.5 text-sm rounded border">Alle</button>
      <button onclick="setFilter('status','ausstehend')" data-filter="status-ausstehend" class="filter-btn px-3 py-1.5 text-sm rounded border">Ausstehend</button>
      <button onclick="setFilter('status','angenommen')" data-filter="status-angenommen" class="filter-btn px-3 py-1.5 text-sm rounded border">Angenommen</button>
      <button onclick="setFilter('status','abgelehnt')" data-filter="status-abgelehnt" class="filter-btn px-3 py-1.5 text-sm rounded border">Abgelehnt</button>
    </div>
  </div>

  <!-- Main table -->
  <div class="bg-white border border-gray-200 rounded-lg overflow-x-auto">
    <table class="w-full text-sm">
      <thead>
        <tr class="bg-gray-50 border-b border-gray-200 text-left">
          <th class="px-3 py-2.5 font-semibold w-[100px]">Tag</th>
          <th class="px-3 py-2.5 font-semibold w-[130px]">Schicht</th>
          <th class="px-3 py-2.5 font-semibold w-[130px]">Bereich</th>
          <th class="px-3 py-2.5 font-semibold w-[180px]">Empfehlung</th>
          <th class="px-3 py-2.5 font-semibold w-[60px] text-center">Bew.</th>
          <th class="px-3 py-2.5 font-semibold w-[60px] text-center">Score</th>
          <th class="px-3 py-2.5 font-semibold">Begruendung</th>
          <th class="px-3 py-2.5 font-semibold w-[140px] text-center no-print">Entscheidung</th>
        </tr>
      </thead>
      <tbody id="table-body"></tbody>
    </table>
  </div>

  <p class="text-xs text-gray-400 mt-4 text-center">
    Generiert durch ordio-lite. Entscheidungen nur lokal gespeichert. Kein Rueckschreiben nach Ordio.
  </p>
</div>

<script>
const DAYS_DE = ['So','Mo','Di','Mi','Do','Fr','Sa'];

const plan = JSON.parse(document.getElementById('plan-data').textContent);
let decisions = {};
let filters = { type: 'all', status: 'all' };
let expandedRows = new Set();

// -- localStorage persistence --
const STORAGE_KEY = 'ordio-freigabe-' + plan.plan_id;
try { decisions = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; } catch(e) {}
function saveDecisions() {
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(decisions)); } catch(e) {}
}

function getStatus(id) { return decisions[id] || 'ausstehend'; }

// -- formatting --
function fmtDate(iso) {
  const d = new Date(iso + 'T00:00:00');
  const day = DAYS_DE[d.getDay()];
  return day + ' ' + String(d.getDate()).padStart(2,'0') + '.' + String(d.getMonth()+1).padStart(2,'0') + '.';
}

function totalScore(sd) {
  return Object.values(sd).reduce((a,b) => a + b, 0);
}

function scoreColor(s) {
  if (s >= 100) return 'bg-green-100 text-green-800';
  if (s >= 80) return 'bg-yellow-100 text-yellow-800';
  return 'bg-red-100 text-red-800';
}

function typeBadge(t) {
  if (t === 'frueh') return '<span class="inline-block px-1.5 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-700">frueh</span>';
  return '<span class="inline-block px-1.5 py-0.5 rounded text-xs font-medium bg-orange-100 text-orange-700">spaet</span>';
}

function statusBadge(s) {
  if (s === 'angenommen') return '<span class="inline-block px-1.5 py-0.5 rounded text-xs font-medium bg-green-100 text-green-700">Angenommen</span>';
  if (s === 'abgelehnt') return '<span class="inline-block px-1.5 py-0.5 rounded text-xs font-medium bg-red-100 text-red-700">Abgelehnt</span>';
  return '<span class="inline-block px-1.5 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-600">Ausstehend</span>';
}

function reasonText(a) {
  const sd = a.score_detail;
  const score = totalScore(sd);
  const lines = [];

  if (a.is_applicant) {
    lines.push('Bewerbung eingegangen. Bewerber-Bonus: +' + sd.applicant + ' Punkte.');
  } else {
    lines.push('Empfehlung: Hoechste verfuegbare Kapazitaet.');
  }

  const parts2 = [];
  if (sd.rest > 0) parts2.push('Restkapazitaet: ' + sd.rest);
  if (sd.fairness > 0) parts2.push('Fairness: ' + sd.fairness + '/30');
  if (parts2.length) lines.push(parts2.join('. ') + '.');

  const parts3 = [];
  if (sd.skill > 0) parts3.push('Skills: ' + a.working_area + '-Match (' + sd.skill + ')');
  if (sd.role > 0) parts3.push('Rollenfit: ' + sd.role);
  if (sd.fixed > 0) parts3.push('Festes Muster (+' + sd.fixed + ')');
  if (sd.preference > 0) parts3.push('Praeferenz (+' + sd.preference + ')');
  if (sd.salary < 0) parts3.push('Gehaltswarnung (' + sd.salary + ')');
  if (parts3.length) lines.push(parts3.join('. ') + '.');

  lines.push('<span class="font-semibold">Gesamt: ' + Math.round(score * 100) / 100 + '</span>');
  return lines.join('<br>');
}

function reasonLabel(key) {
  const map = {
    'remaining_target_hours': 'Restkapazitaet',
    'fair_distribution': 'Fairness',
    'skill_working_area_match': 'Skill-Match',
    'applied_for_shift': 'Bewerbung',
    'role_shift_match': 'Rollenfit',
    'historical_fixed_pattern': 'Festes Muster',
    'matches_employee_preferences': 'Praeferenz',
    'near_salary_limit': 'Gehaltswarnung'
  };
  return map[key] || key;
}

// -- actions --
function decide(id, status) {
  decisions[id] = status;
  saveDecisions();
  render();
}

function acceptAll() {
  plan.assignments.forEach(a => {
    if (getStatus(a.assignment_id) === 'ausstehend') decisions[a.assignment_id] = 'angenommen';
  });
  saveDecisions();
  render();
}

function resetAll() {
  decisions = {};
  saveDecisions();
  render();
}

function toggleAlts(id) {
  if (expandedRows.has(id)) expandedRows.delete(id); else expandedRows.add(id);
  render();
}

function setFilter(group, value) {
  filters[group] = value;
  render();
}

// -- render --
function render() {
  const searchVal = (document.getElementById('search').value || '').toLowerCase();

  // KPI bar
  const kpis = plan.kpis;
  document.getElementById('kpi-bar').innerHTML = [
    kpiCard('Besetzungsrate', kpis.fill_rate + '%'),
    kpiCard('Zugewiesen', kpis.assigned_slots),
    kpiCard('Offen', kpis.unassigned_slots),
    kpiCard('Bewerbungen', kpis.assignment_kinds.applicant),
    kpiCard('Empfehlungen', kpis.assignment_kinds.recommendation_without_applicant),
  ].join('');

  // Meta
  const r = plan.range;
  document.getElementById('meta-line').textContent =
    'Betrieb: ' + plan.betrieb + '  |  ' + fmtDate(r.from) + ' - ' + fmtDate(r.to) + '  |  Plan: ' + plan.plan_id;

  // Filter assignments
  let rows = plan.assignments;

  if (filters.type !== 'all') {
    rows = rows.filter(a => a.shift_type === filters.type);
  }
  if (filters.status !== 'all') {
    rows = rows.filter(a => getStatus(a.assignment_id) === filters.status);
  }
  if (searchVal) {
    rows = rows.filter(a => {
      const haystack = [a.employee, a.working_area, a.date, fmtDate(a.date)].join(' ').toLowerCase();
      return haystack.includes(searchVal);
    });
  }

  // Decision counts (over all, not filtered)
  let pending = 0, accepted = 0, declined = 0;
  plan.assignments.forEach(a => {
    const s = getStatus(a.assignment_id);
    if (s === 'angenommen') accepted++;
    else if (s === 'abgelehnt') declined++;
    else pending++;
  });
  document.getElementById('count-pending').textContent = pending + ' Ausstehend';
  document.getElementById('count-accepted').textContent = accepted + ' Angenommen';
  document.getElementById('count-declined').textContent = declined + ' Abgelehnt';

  // Filter button styling
  document.querySelectorAll('.filter-btn').forEach(btn => {
    const [group, val] = btn.dataset.filter.split('-');
    const active = filters[group] === val;
    btn.className = 'filter-btn px-3 py-1.5 text-sm rounded border ' +
      (active ? 'bg-gray-800 text-white border-gray-800' : 'bg-white text-gray-600 border-gray-300 hover:bg-gray-50');
  });

  // Build table
  const tbody = document.getElementById('table-body');
  let html = '';
  let lastDate = '';

  rows.forEach(a => {
    const id = a.assignment_id;
    const status = getStatus(id);
    const score = totalScore(a.score_detail);
    const isNewDay = a.date !== lastDate;
    lastDate = a.date;
    const rowClass = status === 'angenommen' ? 'row-accepted' : status === 'abgelehnt' ? 'row-declined' : '';
    const expanded = expandedRows.has(id);

    // Day separator
    if (isNewDay) {
      html += '<tr class="border-t-2 border-gray-300"><td colspan="8" class="h-1"></td></tr>';
    }

    html += '<tr class="border-b border-gray-100 hover:bg-gray-50 cursor-pointer ' + rowClass + '" onclick="toggleAlts(\'' + id + '\')">';

    // Tag
    html += '<td class="px-3 py-2.5 align-top">';
    if (isNewDay) html += '<div class="font-semibold">' + fmtDate(a.date) + '</div>';
    html += '</td>';

    // Schicht
    html += '<td class="px-3 py-2.5 align-top">' +
      '<div>' + a.start + '-' + a.end + '</div>' +
      '<div class="mt-0.5">' + typeBadge(a.shift_type) + '</div></td>';

    // Bereich
    html += '<td class="px-3 py-2.5 align-top">' + a.working_area + '</td>';

    // Empfehlung
    html += '<td class="px-3 py-2.5 align-top">' +
      (a.is_applicant ? '<span class="font-bold">' + a.employee + '</span>' : a.employee) +
      '</td>';

    // Bewerbung
    html += '<td class="px-3 py-2.5 align-top text-center">' +
      (a.is_applicant
        ? '<span class="inline-block px-1.5 py-0.5 rounded text-xs font-medium bg-green-100 text-green-700">Ja</span>'
        : '<span class="text-gray-400">--</span>') +
      '</td>';

    // Score
    html += '<td class="px-3 py-2.5 align-top text-center">' +
      '<span class="inline-block px-2 py-0.5 rounded text-xs font-bold ' + scoreColor(score) + '">' +
      Math.round(score * 100) / 100 + '</span></td>';

    // Begruendung
    html += '<td class="px-3 py-2.5 align-top text-xs leading-relaxed">' + reasonText(a) + '</td>';

    // Entscheidung
    html += '<td class="px-3 py-2.5 align-top text-center no-print">' +
      '<div class="flex gap-1 justify-center items-center">' +
      statusBadge(status) +
      '</div>' +
      '<div class="flex gap-1 justify-center mt-1">' +
      '<button onclick="event.stopPropagation();decide(\'' + id + '\',\'angenommen\')" ' +
        'class="px-2 py-1 text-xs rounded ' +
        (status === 'angenommen' ? 'bg-green-200 text-green-800' : 'bg-green-600 text-white hover:bg-green-700') +
        '">Annehmen</button>' +
      '<button onclick="event.stopPropagation();decide(\'' + id + '\',\'abgelehnt\')" ' +
        'class="px-2 py-1 text-xs rounded ' +
        (status === 'abgelehnt' ? 'bg-red-200 text-red-800' : 'bg-red-600 text-white hover:bg-red-700') +
        '">Ablehnen</button>' +
      '</div></td>';

    html += '</tr>';

    // Alternatives row
    if (expanded && a.alternatives.length) {
      html += '<tr class="alt-row open border-b border-gray-100 bg-gray-50">' +
        '<td colspan="8" class="px-3 py-3">' +
        '<div class="text-xs font-semibold text-gray-500 mb-2">Alternativen (Top ' + a.alternatives.length + ')</div>' +
        '<table class="w-full text-xs">' +
        '<thead><tr class="text-left text-gray-500">' +
        '<th class="pb-1 pr-3">#</th>' +
        '<th class="pb-1 pr-3">Kandidat</th>' +
        '<th class="pb-1 pr-3 text-center">Score</th>' +
        '<th class="pb-1 pr-3 text-center">Delta</th>' +
        '<th class="pb-1 pr-3">Gruende</th>' +
        '<th class="pb-1 pr-3">Score-Detail</th>' +
        '</tr></thead><tbody>';

      a.alternatives.forEach((alt, i) => {
        const altScore = alt.score;
        const delta = altScore - score;
        const deltaStr = (delta >= 0 ? '+' : '') + Math.round(delta);
        const deltaColor = delta >= 0 ? 'text-green-700' : 'text-red-600';

        html += '<tr class="border-t border-gray-200">' +
          '<td class="py-1.5 pr-3 text-gray-400">' + (i+1) + '</td>' +
          '<td class="py-1.5 pr-3">' + alt.employee_name + '</td>' +
          '<td class="py-1.5 pr-3 text-center"><span class="inline-block px-1.5 py-0.5 rounded ' + scoreColor(altScore) + '">' + altScore + '</span></td>' +
          '<td class="py-1.5 pr-3 text-center font-mono ' + deltaColor + '">' + deltaStr + '</td>' +
          '<td class="py-1.5 pr-3">' + alt.reasons.map(reasonLabel).join(', ') + '</td>' +
          '<td class="py-1.5 pr-3 text-gray-500">' + fmtScoreDetail(alt.score_detail) + '</td>' +
          '</tr>';
      });

      html += '</tbody></table></td></tr>';
    }
  });

  tbody.innerHTML = html;
}

function fmtScoreDetail(sd) {
  const parts = [];
  if (sd.applicant > 0) parts.push('Bew:' + sd.applicant);
  if (sd.rest > 0) parts.push('Rest:' + sd.rest);
  if (sd.fairness > 0) parts.push('Fair:' + sd.fairness);
  if (sd.skill > 0) parts.push('Skill:' + sd.skill);
  if (sd.role > 0) parts.push('Rolle:' + sd.role);
  if (sd.fixed > 0) parts.push('Fix:' + sd.fixed);
  if (sd.preference > 0) parts.push('Pref:' + sd.preference);
  if (sd.salary < 0) parts.push('Gehalt:' + sd.salary);
  return parts.join(' ');
}

function kpiCard(label, value) {
  return '<div class="bg-gray-50 rounded px-3 py-2 border border-gray-100">' +
    '<div class="text-xs text-gray-500">' + label + '</div>' +
    '<div class="text-lg font-bold">' + value + '</div></div>';
}

// Initial render
render();
</script>

</body>
</html>
